---
title: Pakker i r - magasinr
author: Lucas Bagge
date: '2020-05-17'
slug: pakker-i-r-magasinr
categories:
  - R pakker
tags:
  - R pakker
subtitle: 'Hvad kan det bruges til'
summary: 'I denne post vil jeg beskrive hvordan R-pakke strukturen er og hvordan
man kan det hverdagen letter ved at bruge dem.'
authors: []
lastmod: '2020-05-17T14:23:59+02:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      echo = TRUE, dpi = 300, cache.lazy = FALSE,
                      tidy = "styler", fig.width = 8, fig.height = 5)
library(scales)
library(tidyverse)
```

# Introduktion

R er et af de foretrukkende sprog indenfor Data Scientist feltet. Det bliver
betragtet på lige fod med Python og kan bruges til alt; fra at bygge matematiske
modeller til at lave hjemmesider.

En af fordelene ved at bruge R er dens simple måde at lave R-pakker på. Til 
dette er **Hadleys** bog og hjemmeside; 
https://r-pkgs.org/
noget for sig.
Pakker har den fordel at du kan generalisere arbejdsopgaver og skabe en gennemsigtighed
for dine kollegaer, som ikke nødvendigvis er så komfortable med scripting.
I denne post vil jeg vise en simpel pakke struktur og hvordan man kan gøre arbejdsopgaver
lettere. 

# Struktur

Det er utrolig simpel at lave en pakkke og med Rstudio **addins**, så kan det 
gøres med et enkelt tryk.

En korrekt struktur vil se ud på føglende måde:

![**Pakke struktur**](/post/2020-05-17-pakker-i-r-magasinr_files/pakke_struktur.png.PNG)

Ud fra ovenstående kan vi se hvordan strukturen er. Jeg vil kun gå igennem de mest 
essentielle folder og filer.

- `R` er den folder hvor vi har alle ens funktioner.
- `test` er hvor vi inkluderer test af vores funktioner, så vi sikrer os alt 
kører som det skal.
- `DESCRIPTION` er hvad pakken skal indeholder. Her definerer vi også andre pakker,
så man ikke er nød til at hente dem i funktionerne.

# Funktioner

Funktioner er med til at skabe et flow i sit arbejde og så man ikke er nød til at
kører lange script igennem hele tiden. Hertil kan man også lave dokumentation, så 
man kan let finde ud af hvad funktionen gør. 

Jeg vil vise to eksempler på nogle funktioner, som jeg har bygget og som gør
det lettere for mig selv, men også mine kollegaer at skrive koden.

## Hent data

Man er ofte nød til at hente data fra forskellig kilder. Det kan man gøre på forskellig 
vis. Hvis man bruge Google Big query så kan man benytte sig af quries. Dog kan
man i `R` skrive kode forklædt som quries og hente data. 

Hvis vi ser følgende;

```{r}
#' Query the Gefion database for data.
#'
#' Make connection to Gefion database.
#'
#' Details.
#'
#' @param statement SQL statement to execute against the DB.
#' @param username The Gefion user to connect with.
#' @param password The Gefion user's password.
#'
#' @return A data frame with the query result.
#'
#' @export
gefion_query <- function(statement, username, password) {

  connection <- gefion_connection(username = username, password = password)

  result <- DBI::dbGetQuery(connection, statement) %>% as_tibble()

  DBI::dbDisconnect(connection)

  # do your preprocessing with result here result <- result %>% ...
  result <- result %>% rename_all(tolower)

  result
}
```

Så er det hvordan en simpel funktion vil se ud. Her har vi en titel, beskrivelse
og selve funktionen. Denne funktion går det let for brugeren at skabe en forbindelse
til en datawarehouse og hente det data man ønsker.
Her kan brugeren måske være i tvivl om hvad funktionen gør, men R laver dokumentation
for en, som man let kan finde ved at trykke f1.

![**Funktion dokumentation**](/post/2020-05-17-pakker-i-r-magasinr_files/docg.PNG)

Det er altså let og meget gennemskueligt for brugeren, når en funktion skal burges.
Hermed skaber man en let måde at hente data og lave noget manipulation, såsom
at gøre bogstaver små, som gøres foroven med `rename_all(tolower)`.

## Plot funktion

Uanset i hvilken position man sidder i er det ofte nødvendig at lave grafer over
sit data. Det kan være tidskrævende uanset om man bruge excel, R eller
Python. Derfor er det en god ide at lave en graf-funktion, som har alle de ønskede
funktionaliteter. Hermed mener jeg at man sørger for den kan plotte linjer, facet,
liggende, aggeringer osv.

Det er noget jeg har arbejdet på med at lave følgende funktion der gør
denne type opgaver så meget letter:

Selve funktioner er lang, så jeg viser et udsnit af den;

```{r, results='hide'}
# Input til funktionen;
function(data, x, y, type, groups = NULL, facets = NULL, bubble_size,
                     low_limit_y = NULL, up_limit_y = NULL, y_breaks = 5,
                     low_limit_x = NULL, up_limit_x = NULL, x_breaks = 5,
                     y_lab, x_lab, title, axis_title_size = 10, axis_label_size = 8,
                     data_labels = FALSE, data_label_size = 4, label_vjust = 1, label_hjust = 0.5,
                     show_legend = TRUE, show_legend_title= FALSE, legend_cols = 4,
                     legend_position = "bottom",  group_name, panel_spaces = 2, scale_y_lab = T,
                     dodge_width = 1, dodge_preserve = "single",
                     interactive = FALSE, tooltips){
# Selve funktionen;
  data <- data %>%
    dplyr::ungroup() %>%
    dplyr::mutate(old_y = !!(as.name(y))) %>%
    dplyr::mutate(!!y := annalectr:::label.format(!!(as.name(y))))

  if (!missing(bubble_size)) {
    if (!grepl("\\D", bubble_size)) {
      bubble_size <- as.numeric(bubble_size)
    }
  }else{
    bubble_size <- NULL
  }

  if (type == "bubble") {
    data <- data %>% dplyr::mutate(old_bubble_size = !!(as.name(bubble_size))) %>%
      dplyr::mutate(!!bubble_size := annalectr:::label.format(!!(as.name(bubble_size))))
  }

  if (is.null(groups)) {
    show_legend <- FALSE
  }
  #.
  #.
  #.
  # osv.
}
```

Her kan man igen læse en god beskrivelse af hvad funktionen gør. Man kan til og 
med inkluderer et eksempel.

Men her kan man tage sit data og lave nogle hurtige plots, med meget få koder,
som før ville have krævet meget mere.

# Konklusion

Jeg har her gennemgået hvordan man kan lette arbejdsprocessen for ens kollegaer
ved at lave funktioner, som gør det hurtigere og letter at hente data og
visualiserer det.



