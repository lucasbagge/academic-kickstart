---
title: Product prices prediction
author: Lucas Bagge
date: '2020-05-20'
slug: product-prices-prediction
categories:
  - parship
  - tidymodels
  - prediction
  - xgboost
tags:
  - xgboost
  - tidymodels
subtitle: ''
summary: ''
authors: []
lastmod: '2020-05-20T22:22:59+02:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---
```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      echo = TRUE, dpi = 300, cache.lazy = FALSE,
                      tidy = "styler", fig.width = 8, fig.height = 5)
# Tidymodels
library(tune)
library(dials)
library(parsnip)
library(rsample)
library(recipes)
#library(textrecipes)
library(yardstick)
library(vip)

# Parallel Processing
library(doParallel)
all_cores <- parallel::detectCores(logical = FALSE)
registerDoParallel(cores = all_cores)

# Data Cleaning
library(janitor)

# EDA 
library(skimr)
library(correlationfunnel)
library(DataExplorer)

# ggplot2 Helpers
library(gghighlight)
library(patchwork)

# Core
library(tidyverse)
library(tidyquant)
library(knitr)
```

# Data

```{r}
car_prices <- read.csv("data_car.csv") %>% 
  clean_names() %>% 
  select(msrp, everything()) %>% 
  mutate_if(is.factor, as.character)

car_prices %>% 
  head(5) %>% 
  kableExtra::kable()
```

Jeg vil bruge `ggplot` til at skabe en forståelse af korrelationer og finde
**key feature** i data.

## Engine og MSRP

Der er to faktor vi er interesseret i:
- **MSRP (prisen)** - Vores mål. Det er hvad kunden gennemsnitlig betaler for bilen.
- **Engie** - Et mål for hvor godt produktet performer.

```{r}
car_plot <- car_prices %>% 
  mutate(make_model = str_c(make, " ", model)) %>% 
  select(msrp, engine_hp, make_model)

car_plot %>% 
  ggplot(aes(engine_hp, msrp)) +
  geom_point(color = palette_light()["blue"], alpha = 0.15) +
  geom_smooth(method = "lm") +
  scale_y_log10(label = scales::dollar_format()) +
  theme_tq() +
  labs( 
    title = "Engine mod MSRP i forhold til alderen",
    x = "Engine",
    y = "MSRP (log scale)")
```

Umiddelbart fra plottet kan vi se der er to grupper. Hvordan kan vi bedre identificer dem?
Her kan vi bruge `gghighlight` og `patchwork`.

Jeg kommer til at fokuser på den højde fraktil af begge grupper:
- Biler med en MSRP på større end 650,000.
- Biler med en engine med større end 350 og MSRP på mere end 10000

```{r}
p1 <- car_plot %>% 
  ggplot(
    aes(
      engine_hp,
      msrp
    )
  ) +
  geom_point(color = palette_light()["blue"]) +
  scale_y_log10(label = scales::dollar_format()) +
  gghighlight(msrp > 650000,
              label_key = make_model,
              unhighlighted_colour = alpha("grey", 0.05),
              label_params = list(size = 2.5)) +
  theme_tq() +
  labs(title = "Biler med en MSRP større end $650k",
       x = "Engine",
       y = "MSRP (log Scales)")

p2 <- car_plot %>%
    ggplot(aes(engine_hp, msrp)) +
    geom_point(color = palette_light()["blue"]) +
    scale_y_log10(label = scales::dollar_format()) +
    gghighlight(msrp < 10000, engine_hp > 350, label_key = make_model, 
                unhighlighted_colour = alpha("grey", 0.05),
                label_params = list(size = 2.5), ) +
    theme_tq() +
  labs(title = "Biler med en MSRP < $10k og Engine > 350",
       x = "Engine",
       y = "MSRP (log scale")

p1 / p2
```

Fra det første plot så giver vores udfald i forhold til produkter god mening da
vi ser det er nogle af de dyre mærker; Lamboughin ogsv.
Den anden grund er mere interessant da BMW 8 Serie, Mercedes virker mærkeligt
da de har en høj pris.

## Correlation analyse

Når vi har biler så er der en række faktor som spiller ind i forhold til prisen.
Hvilke faktor der spiller mest ind er dog interessant og det vil jeg dykke ned i.

```{r}
# correlationfunnel 3-step process
library(correlationfunnel)

car_prices %>%
  select_if(is.factor) %>%   
  drop_na() %>% 
  binarize(n_bins = 4)  %>%  
  correlate(target = make__Acura) %>%
  plot_correlation_funnel()
```



## Engie, MSRP ved bilens alder

Lad os lave en graf igen fra tidligere. Her vil vi dog sammenligne med biler
der er er forskel i aldren

```{r}
car_plot <-  car_prices %>% 
  mutate(make_model = str_c(make, " ", model),
         year_lte_2000 = ifelse(year <= 2000, "2000 eller ældre", "2001 eller nyerer")) %>% 
  select(msrp, year_lte_2000, engine_hp, make_model)

car_plot %>% 
  ggplot(aes(engine_hp, msrp, color = year_lte_2000)) +
  geom_point(color = palette_light()["blue"], alpha = 0.15) +
  geom_smooth(method = "lm") +
  scale_y_log10(label = scales::dollar_format()) +
  theme_tq() +
  labs( 
    title = "Engine mod MSRP i forhold til alderen",
    x = "Engine",
    y = "MSRP (log scale)")
```

Vi ser altså at alderen på bilen har stor inflydelse på prisen og det forklare
hvorfor vi har de oprindelig to grupper.

# EDA

For at se på vores data og hvor mange manglende værdier og unikke observationer 
vi har bruger jeg `skrimr`

```{r}
car_prices %>% skim()
```

