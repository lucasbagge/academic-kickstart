---
title: Natural gas prediction
author: Lucas Bagge
date: '2020-05-07'
slug: natural-gas-prediction
categories:
  - tidymodels
  - energi prices
  - time seres
tags:
  - tidymodels
  - energi prices
  - time series
subtitle: 'Price prediction univarite stochastic level using tidymodels'
summary: ''
authors: []
lastmod: '2020-05-07T05:41:08+02:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>For many time series models the biggst task is to make forcast for the future.
In a so called <strong>state space analysis</strong> the time series observations are assumed to
depend linearly on a state vector, which are generated by a stochastic dynamic process.
The observations are also assumed to subject to measurment error and independent
of the state vector. Therfore the two main component is the observed and unobserved
states of the data.</p>
<p>Kalman filter is a smooth function der estimere mean niveau, where the serie fluctuate
around. I think about a time variation equlibirum. it is a mean that can variate
over time. den betinget middelværdi der ahænger af tiden. Hvis du har estimere
det sturkturelle niveau og har en afvigelse du ligger over det, så vil du forvente
en mean revertion.</p>
</div>
<div id="data-and-visualization" class="section level1">
<h1>Data and visualization</h1>
<p>We will be using the functionality of <code>quantmod</code> to get data for the natural gas.</p>
<pre class="r"><code>ng &lt;- getSymbols(
  &quot;NG&quot;,
  auto.assign = FALSE
)
tail(ng)</code></pre>
<pre><code>##            NG.Open NG.High NG.Low NG.Close NG.Volume NG.Adjusted
## 2020-05-01   10.91   11.49  10.86    11.40   4044500       11.40
## 2020-05-04   11.71   11.89  11.39    11.51   2374000       11.51
## 2020-05-05   11.57   11.87  11.17    11.73   2676700       11.73
## 2020-05-06   11.60   11.60  11.18    11.19   2160400       11.19
## 2020-05-07   11.40   11.96  11.09    11.80   3014900       11.80
## 2020-05-08   11.80   12.00  11.27    11.47   2989400       11.47</code></pre>
<p>A quick vizual interpretation for the data can be used with the same package.</p>
<pre class="r"><code>barChart(ng)</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-2-1.png" width="2400" /></p>
<p>The series look non-stationary and very volatile. It can also be spotted that
there is some sesonality in the data, where we have a spike in the winter period.</p>
<p>For our analysis I am gonna use Close prices. For making the computinal a litlle
easier the analysis is maded for monthly data.</p>
<pre class="r"><code>ng_close &lt;- Cl(ng)

ng_close_month &lt;- apply.monthly(ng_close, mean)

ng_close_month_tidy &lt;- tidy(ng_close_month)

plot(ng_close_month)</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-3-1.png" width="2400" /></p>
<p>When we work with statistical modelling they often rely on a <strong>normal distribution</strong>
by that I mean a distribution that is symmetric and has a bell shape.</p>
<pre class="r"><code>ng_close_month_tidy %&gt;%
  ggplot(
    aes(
      x = value
    )
  ) +
  geom_histogram(
    aes(
      y = ..density..
    ),
    position = &quot;identity&quot;,
    binwidth = 1,
    colour = &quot;black&quot;,
    fill = &quot;turquoise&quot;,
    alpha = 0.6
  ) +
  geom_density(
    alpha = 0.6,
    fill = &quot;#FF6666&quot;
  ) +
  scale_color_brewer(
    palette = &quot;Accent&quot;
  ) +
  theme_pubclean() +
  labs(
    title = &quot;Weight density curve&quot;,
    x = &quot;Price&quot;,
    y = &quot;Density&quot;
  )</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-4-1.png" width="2400" /></p>
<pre class="r"><code>ng_close_month_tidy %&gt;%
  ggqqplot(
    x = &quot;value&quot;,
    palette = &quot;#FC4E07&quot;,
    ggtheme = theme_pubclean()
  )</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-5-1.png" width="2400" /></p>
<p>From the density and QQ plot it is clear to see that we don´t have a normal
distribution</p>
<div id="stationarity-test" class="section level2">
<h2>Stationarity test</h2>
<p>We can almost immently say that the time series is not statinary. For a
ananlyis os this see the following graph,</p>
<pre class="r"><code>ng_close_month_tidy %&gt;%
  ggplot(
    aes(
      x = index,
      y = value
    )
  ) +
  geom_line(
    color = &quot;indianred3&quot;,
    size = 1
  ) +
  geom_smooth() +
  labs(
    title = &quot;Natural Gas&quot;,
    subtitle = &quot;2000 to 2020&quot;,
    x = &quot;&quot;,
    y = &quot;Close price&quot;
  ) +
  theme_minimal()</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-6-1.png" width="2400" /></p>
<pre class="r"><code>ggplot.corr &lt;- function(data, lag.max = 24, ci = 0.95, large.sample.size = TRUE, horizontal = TRUE, ...) {
  require(ggplot2)
  require(dplyr)
  require(cowplot)

  if (horizontal == TRUE) {
    numofrow &lt;- 1
  } else {
    numofrow &lt;- 2
  }

  list.acf &lt;- acf(data, lag.max = lag.max, type = &quot;correlation&quot;, plot = FALSE)
  N &lt;- as.numeric(list.acf$n.used)
  df1 &lt;- data.frame(lag = list.acf$lag, acf = list.acf$acf)
  df1$lag.acf &lt;- dplyr::lag(df1$acf, default = 0)
  df1$lag.acf[2] &lt;- 0
  df1$lag.acf.cumsum &lt;- cumsum((df1$lag.acf)^2)
  df1$acfstd &lt;- sqrt(1 / N * (1 + 2 * df1$lag.acf.cumsum))
  df1$acfstd[1] &lt;- 0
  df1 &lt;- select(df1, lag, acf, acfstd)

  list.pacf &lt;- acf(data, lag.max = lag.max, type = &quot;partial&quot;, plot = FALSE)
  df2 &lt;- data.frame(lag = list.pacf$lag, pacf = list.pacf$acf)
  df2$pacfstd &lt;- sqrt(1 / N)

  if (large.sample.size == TRUE) {
    plot.acf &lt;- ggplot(data = df1, aes(x = lag, y = acf)) +
      geom_area(aes(x = lag, y = qnorm((1 + ci) / 2) * acfstd), fill = &quot;#B9CFE7&quot;) +
      geom_area(aes(x = lag, y = -qnorm((1 + ci) / 2) * acfstd), fill = &quot;#B9CFE7&quot;) +
      geom_col(fill = &quot;#4373B6&quot;, width = 0.7) +
      scale_x_continuous(breaks = seq(0, max(df1$lag), 6)) +
      scale_y_continuous(
        name = element_blank(),
        limits = c(min(df1$acf, df2$pacf), 1)
      ) +
      ggtitle(&quot;ACF&quot;) +
      theme_bw()

    plot.pacf &lt;- ggplot(data = df2, aes(x = lag, y = pacf)) +
      geom_area(aes(x = lag, y = qnorm((1 + ci) / 2) * pacfstd), fill = &quot;#B9CFE7&quot;) +
      geom_area(aes(x = lag, y = -qnorm((1 + ci) / 2) * pacfstd), fill = &quot;#B9CFE7&quot;) +
      geom_col(fill = &quot;#4373B6&quot;, width = 0.7) +
      scale_x_continuous(breaks = seq(0, max(df2$lag, na.rm = TRUE), 6)) +
      scale_y_continuous(
        name = element_blank(),
        limits = c(min(df1$acf, df2$pacf), 1)
      ) +
      ggtitle(&quot;PACF&quot;) +
      theme_bw()
  }
  else {
    plot.acf &lt;- ggplot(data = df1, aes(x = lag, y = acf)) +
      geom_col(fill = &quot;#4373B6&quot;, width = 0.7) +
      geom_hline(
        yintercept = qnorm((1 + ci) / 2) / sqrt(N),
        colour = &quot;sandybrown&quot;,
        linetype = &quot;dashed&quot;
      ) +
      geom_hline(
        yintercept = -qnorm((1 + ci) / 2) / sqrt(N),
        colour = &quot;sandybrown&quot;,
        linetype = &quot;dashed&quot;
      ) +
      scale_x_continuous(breaks = seq(0, max(df1$lag), 6)) +
      scale_y_continuous(
        name = element_blank(),
        limits = c(min(df1$acf, df2$pacf), 1)
      ) +
      ggtitle(&quot;ACF&quot;) +
      theme_bw()

    plot.pacf &lt;- ggplot(data = df2, aes(x = lag, y = pacf)) +
      geom_col(fill = &quot;#4373B6&quot;, width = 0.7) +
      geom_hline(
        yintercept = qnorm((1 + ci) / 2) / sqrt(N),
        colour = &quot;sandybrown&quot;,
        linetype = &quot;dashed&quot;
      ) +
      geom_hline(
        yintercept = -qnorm((1 + ci) / 2) / sqrt(N),
        colour = &quot;sandybrown&quot;,
        linetype = &quot;dashed&quot;
      ) +
      scale_x_continuous(breaks = seq(0, max(df2$lag, na.rm = TRUE), 6)) +
      scale_y_continuous(
        name = element_blank(),
        limits = c(min(df1$acf, df2$pacf), 1)
      ) +
      ggtitle(&quot;PACF&quot;) +
      theme_bw()
  }
  cowplot::plot_grid(plot.acf, plot.pacf, nrow = numofrow)
}</code></pre>
<pre class="r"><code>ng_close_month_ts &lt;- ts(ng_close_month$NG.Close,
  start = c(2007, 1),
  end = c(2020, 5),
  frequency = 12
)
ggplot.corr(
  data = ng_close_month_ts,
  lag.max = 10,
  ci = 0.95,
  large.sample.size = TRUE,
  horizontal = TRUE
)</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-8-1.png" width="2400" /></p>
<pre class="r"><code>adf.test(ng_close_month_ts)</code></pre>
<pre><code>## 
##  Augmented Dickey-Fuller Test
## 
## data:  ng_close_month_ts
## Dickey-Fuller = -2.1466, Lag order = 5, p-value = 0.5152
## alternative hypothesis: stationary</code></pre>
<pre class="r"><code>pp.test(ng_close_month_ts)</code></pre>
<pre><code>## 
##  Phillips-Perron Unit Root Test
## 
## data:  ng_close_month_ts
## Dickey-Fuller Z(alpha) = -8.5783, Truncation lag parameter = 4, p-value
## = 0.6229
## alternative hypothesis: stationary</code></pre>
<pre class="r"><code>kpss.test(ng_close_month_ts)</code></pre>
<pre><code>## 
##  KPSS Test for Level Stationarity
## 
## data:  ng_close_month_ts
## KPSS Level = 0.95052, Truncation lag parameter = 4, p-value = 0.01</code></pre>
<pre class="r"><code>ptibble &lt;- tribble(
  ~Test, ~&quot;P-value&quot;,
  &quot;ADF&quot;, 0.5116,
  &quot;PP&quot;, 0.6207,
  &quot;KPSS&quot;, 0.01
)
ptibble %&gt;%
  kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Test</th>
<th align="right">P-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ADF</td>
<td align="right">0.5116</td>
</tr>
<tr class="even">
<td align="left">PP</td>
<td align="right">0.6207</td>
</tr>
<tr class="odd">
<td align="left">KPSS</td>
<td align="right">0.0100</td>
</tr>
<tr class="even">
<td align="left">From ou</td>
<td align="right">r stationary test the conclusion is that the time serie is not statinory.</td>
</tr>
</tbody>
</table>
<p>It is important to normalize each trend in the data;</p>
<pre class="r"><code>ng_sta &lt;- rnorm(length(ng_close_month_ts),
  mean = 1,
  sd = 1
)
ng_trend &lt;- cumsum(rnorm(length(ng_close_month_ts),
  mean = 1,
  sd = 4
)) +
  ng_close_month_ts / 100

# normlization

ng_sta &lt;- ng_sta / max(ng_sta)
ng_trend &lt;- ng_trend / max(ng_trend)</code></pre>
<pre class="r"><code>ng_sta_tidy &lt;- tidy(ng_sta)

ng_test &lt;- ts(ng_sta,
  start = c(2007, 1),
  end = c(2020, 5),
  frequency = 12
)
ng_test_tidyr &lt;- tidy(ng_test)

plot(ng_sta, type = &quot;l&quot;)</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-11-1.png" width="2400" /></p>
<pre class="r"><code>ng_test_tidyr %&gt;%
  ggplot(
    aes(
      x = index,
      y = value
    )
  ) +
  geom_line(
    color = &quot;indianred3&quot;,
    size = 1
  ) +
  labs(
    title = &quot;Natural Gas stationary&quot;,
    subtitle = &quot;2000 to 2020&quot;,
    x = &quot;&quot;,
    y = &quot;Close price&quot;
  ) +
  theme_minimal()</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-11-2.png" width="2400" /></p>
<pre class="r"><code>ng_trend_tidy &lt;- tidy(ng_trend)

ng_trend_tidy %&gt;%
  ggplot(
    aes(
      x = index,
      y = value
    )
  ) +
  geom_line(
    color = &quot;indianred3&quot;,
    size = 1
  ) +
  labs(
    title = &quot;Natural Gas stationary&quot;,
    subtitle = &quot;2000 to 2020&quot;,
    x = &quot;&quot;,
    y = &quot;Close price&quot;
  ) +
  theme_minimal()</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-12-1.png" width="2400" /></p>
<p>Missing a good acf</p>
<p>From the acf it can be concluded that the trend is not stationar.</p>
</div>
</div>
<div id="decomposing" class="section level1">
<h1>Decomposing</h1>
<p>A time series often have the following component; trend, random and seasonal component.
What decomposing is about is to seperate the diffferent part and look at them
apart.</p>
<pre class="r"><code>ng_close_month_ts %&gt;%
  decompose() %&gt;%
  autoplot() +
  theme_minimal()</code></pre>
<p><img src="/post/2020-05-07-natural-gas-prediction_files/figure-html/unnamed-chunk-13-1.png" width="2400" /></p>
<p>We can see there is a sesonal component mostly in the winter period where people need
to buy more gas for heat. Overall the price is very volatile and have random
walk movement.</p>
</div>
<div id="modelling" class="section level1">
<h1>Modelling</h1>
<p>State models are based on the idea that we have an unobserved process we would
like to say something about. There a different types and furthere complicated state
space models. For the more simply model there is <strong>local level</strong>, which involve two equations
one explaning the observded path and the other the unobserved path. It is woth mentioning
that because we assume it is a random walk so the series is non stationary.</p>
</div>
